# ðŸ”¹ Use Node.js Alpine for a smaller image
ARG NODE_VERSION=20.9.0-alpine
FROM node:${NODE_VERSION} AS base

# ðŸ”¹ Set non-root user for better security
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# ðŸ”¹ Set working directory
WORKDIR /app

# ðŸ”¹ Copy only package files to optimize Docker caching
COPY package*.json ./

# ðŸ”¹ Install dependencies
RUN npm ci --legacy-peer-deps

# ðŸ”¹ Copy the rest of the application code
COPY . .

# ðŸ”¹ Change ownership to non-root user
RUN chown -R appuser:appgroup /app

# ðŸ”¹ Expose Vite development server & WebSockets
EXPOSE 5173 24678

# ðŸ”¹ Switch to non-root user
USER appuser

# ðŸ”¹ Start Vite with explicit host binding & WebSocket fixes
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173"]
